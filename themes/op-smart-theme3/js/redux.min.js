jQuery(document).ready(function(t){function i(i,d){this.prefix=i+"_",this.nr=d,this.lists={},this.tags={},this.$integrationType=t("#"+this.prefix+"integration_type_"+this.nr+"-select"),this.$providerList=t("#"+this.prefix+"list_"+this.nr+"-select"),this.$providerFields=t("#"+this.prefix+"field_"+this.nr+"-select"),this.$gtwIntegration=t("#"+this.prefix+"gotowebinar_"+this.nr),this.$gtwList=t("#"+this.prefix+"gotowebinar_list_"+this.nr+"-select"),this.tmpObject=t("<div />"),this.elSelector="#accordion-table-op3_integration_settings_accordion_start_"+this.nr,this.$content=t(this.elSelector);var c=this;this.fetchProviderList=function(){void 0===e?e=t.ajax({url:op3_rest_object.api_url+"optin/integrations/connected",beforeSend:function(t){t.setRequestHeader("X-WP-Nonce",op3_rest_object.api_nonce)}}):c.$integrationType.val(redux.options[c.prefix+"integration_type_"+c.nr]).trigger("change"),e.done(function(i){t.each(i.data,function(i,e){"email"!==e.provider&&c.$integrationType.append(t('<option value=""></option>').attr("value",e.provider).text(e.title))}),c.$integrationType.val(redux.options[c.prefix+"integration_type_"+c.nr]).trigger("change")})},this.fetchProviderItems=function(i){"email"!==i&&"custom"!==i&&"oneshoppingcart"!==i&&"arpreach"!==i?(void 0===o[i]&&(o[i]=t.ajax({url:op3_rest_object.api_url+"optin/integrations/"+i+"/lists",beforeSend:function(t){t.setRequestHeader("X-WP-Nonce",op3_rest_object.api_nonce)}})),o[i].done(function(e){if(!e)return!1;var n=[];e.data.forEach(function(t){n[t.id]=[t.name]}),c.lists[i]=n,c.$providerList.find("option").remove(),c.$providerList.append('<option value=""></option>'),t.each(e.data,function(i,e){c.$providerList.append(t("<option></option>").attr("value",e.id).text(e.name))}),c.$providerList.val(redux.options[c.prefix+"list_"+c.nr]).trigger("change")}),c.$providerList.val(redux.options[c.prefix+"list_"+c.nr]).trigger("change")):this.$providerList.val(redux.options[this.prefix+"list_"+this.nr]).trigger("change")},this.fetchProviderFields=function(i,e){"arpreach"===i&&(e="arpreach"),null!==this.lists&&void 0!==this.lists[i]&&void 0!==this.lists[i][e]&&(void 0===this.lists[i][e].fields?t.ajax({url:op3_rest_object.api_url+"optin/integrations/"+i+"/fields/"+e,beforeSend:function(t){t.setRequestHeader("X-WP-Nonce",op3_rest_object.api_nonce)}}).done(function(t){void 0!==t.data&&(c.lists[i][e].fields=t.data),void 0!==t.action&&(c.lists[i][e].action=t.action),void 0!==t.hidden&&(c.lists[i][e].hidden=t.hidden),c.handleListSwitching(i,e)}):this.handleListSwitching(i,e))},this.fetchProviderTags=function(i){void 0===this.tags[i]?t.ajax({url:op3_rest_object.api_url+"optin/integrations/"+i+"/tags",beforeSend:function(t){t.setRequestHeader("X-WP-Nonce",op3_rest_object.api_nonce)}}).done(function(t){c.tags[i]=t.data,c.handleTagsSwitching(i)}):this.handleTagsSwitching(i)},this.handleListSwitching=function(i,e){this.fillProviderCustomFields(this.lists[i][e].fields),r.indexOf(i)>=0&&this.fillProviderGdprDropdownFields(this.lists[i][e].fields),s.indexOf(i)>=0&&this.fillProviderConsentNoteField(this.lists[i][e].fields),void 0!==this.lists[i][e].action&&t("#op3_integration_settings_action_page_"+this.nr).val(this.lists[i][e].action),void 0!==this.lists[i][e].hidden&&this.fillHiddenFields(this.lists[i][e].hidden)},this.handleTagsSwitching=function(t){void 0!==this.tags[t]&&this.fillProviderGdprDropdownFields(this.tags[t])},this.parseHtml=function(e){var n,o,a;try{this.tmpObject.html(e.replace(/<!--.*-->/g,"").replace(/<script\b[^<]*(?:(?!<\/script>)<[^<]*)*<\/script>/gi,"").replace(/<script.*/gi,""))}catch(t){}var r=this.tmpObject.find("form[action]");if(r.length>0){t("#"+i+"_action_"+this.nr).val(r.attr("action")),t("#"+i+"_method_"+this.nr+"-select").val(r.attr("method")).trigger("change");var s={},d={};t(":input[name]:not(:button,:submit)",r).each(function(){field=t(this).attr("name"),s[field]=field}),this.fillProviderCustomFields(s);var c=redux.options["op3_integration_settings_email_"+this.nr],p=redux.options["op3_integration_settings_name_"+this.nr],l=t("#"+i+"_email_"+this.nr+"-select"),h=t("#"+i+"_name_"+this.nr+"-select");void 0!==c&&""!==c?(l.val(c).trigger("change"),n=c):l.val("email").trigger("change"),void 0!==p&&""!==p?(h.val(p).trigger("change"),o=p):h.val("name").trigger("change"),t(":input",this.tmpObject).each(function(){var i=t(this).attr("name");void 0!==i&&(d[i]=t(this).val())});for(a in s)!s.hasOwnProperty(a)||void 0===d[a]||a!==n&&a!==o||delete d[a];this.fillHiddenFields(d)}},this.fillHiddenFields=function(e){var n="";t.each(e,function(t,i){n+='<input type="hidden" name="'+t+'" value="'+i+'" />'}),t("input#"+i+"_hidden_"+this.nr).val(n)},this.initGtwIntegrationFields=function(){void 0===n&&(n=t.ajax({type:"POST",url:ajaxurl,data:{action:OptimizePress.SN+"-email-provider-enabled",provider:"gotowebinar"},dataType:"json"})),n.done(function(t){1==t?c.$gtwIntegration.trigger("change"):c.$gtwIntegration.closest("tr").addClass("hidden")})},this.fillProviderGdprDropdownFields=function(i){var e=t(".op-gdpr-provider-tags-dropdown-"+this.nr+" select");e.find("option:gt(0)").remove(),t.each(e,function(e,n){t(n).append(t("<option></option>").attr("value","-").text("Do not apply a tag")),t.each(i,function(i,e){t(n).append(t("<option></option>").attr("value",e.id).text(e.name))});var o=t(n).attr("id").replace("-select","");"undefined"===redux.options[o]&&""===redux.options[o]||t(n).val(redux.options[o])})},this.fillProviderConsentNoteField=function(i){var e=t("#op3_integration_settings_consent_notes_field_"+this.nr+"-select");t.each(i,function(i,n){e.append(t("<option></option>").attr("value",n.id).text(n.name))});var n=e.attr("id").replace("-select","");"undefined"===redux.options[n]&&""===redux.options[n]||e.val(redux.options[n])},this.fillProviderCustomFields=function(i){var e=t("select.op-form-regular-field-selector"),n=t("select.op-form-extra-field-selector");e.find("option:gt(0)").remove(),n.find("option:gt(1)").remove(),t.each(e,function(e,n){t.each(i,function(i,e){t(n).append(t("<option></option>").attr("value",e.id).text(e.label))});var o=t(n).parent().attr("data-id"),a="";if(void 0!==redux.options[o])t(n).val(redux.options[o]).trigger("change");else if(t(n).attr("id")===c.prefix+"name_"+c.nr+"-select"){switch(c.$integrationType.val()){case"activecampaign":case"arpreach":case"constantcontact":case"egoi":case"emma":case"maropost":a="first_name";break;case"campaignmonitor":a="Name";break;case"aweber":case"convertkit":case"getresponse":case"icontact":a="name";break;case"officeautopilot":case"ontraport":a="First-Name";break;case"infusionsoft":a="inf_field_FirstName";break;case"mailchimp":a="FNAME";break;case"mailpoet":a="firstname";break;case"sendlane":a="sender_name"}t(n).val(a).trigger("change")}}),t.each(n,function(e,n){t.each(i,function(i,e){t(n).append(t("<option></option>").attr("value",e.id).text(e.name))});var o=t(n).parent().attr("data-id").split("-"),a=o.pop();"string"!=typeof redux.options[c.prefix+extra_fields]&&void 0!==redux.options[c.prefix+extra_fields][o.join("-")][a]&&t(n).val(redux.options[c.prefix+extra_fields][o.join("-")][a]).trigger("change")})},this.$integrationType.on("change",function(){c.fetchProviderItems(this.value),a.concat(r).indexOf(c.$integrationType.val())<0&&c.fetchProviderTags(c.$integrationType.val())}),this.$providerList.on("change",function(t){c.fetchProviderFields(c.$integrationType.val(),this.value)})}var e,n,o={},a=["aweber","email","custom"],r=["mailchimp","campaignmonitor","emma","icontact","mailpoet"],s=["campaignmonitor","egoi","emma","icontact","infusionsoft","mailpoet","getresponse","ontraport","campaignrefinery"];t("div.op-optin-accordion").each(function(e){var n=t(this).next().find("input.op-optin-integration-id").val();if(n){new i("op3_integration_settings",n).fetchProviderList()}}),t("body").on("blur","input.op-integration-name",function(){var i=t(this).val(),e=t(this).attr("class"),n=(n=e.split(/op-integration-name-(\d+)/i))[1];t(".op-integration-select").each(function(){t(this).find('option[value="'+n+'"]').text(i).trigger("change")})}),isIntegrationChanged=!1;var d=function(i){var e=i.val(),n=(n=i.attr("class").split(/op-integration-name-(\d+)/i))[1];t(".op-optin-accordion-"+n).find(".control h3").text(e)};t("body").on("keyup","input.op-integration-name",function(){var i=t(this);d(i)}),t("input.op-integration-name").each(function(){var i=t(this);d(i)});var c=t("input.op-integrations-number").val();t("body").on("change",".redux-slider-container.op-integrations-number",function(i){t(this).val()!==c&&(t("#redux_ajax_overlay").css({display:"block"}),redux.args.ajax_save=!1,t("#redux_save").trigger("click"))})});